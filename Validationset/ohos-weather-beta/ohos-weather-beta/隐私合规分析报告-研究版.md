# 天气应用隐私合规分析报告（研究版）

**分析对象：** ohos-weather-beta  
**分析日期：** 2025年11月4日  
**分析人员：** [您的姓名]  
**分析目的：** 功能-隐私映射研究，模块划分方法探索

---

## 一、功能模块划分方法论

### 1.1 划分原则

基于**用户视角**的功能模块划分，而非技术架构划分：

| 划分维度 | 说明 | 示例 |
|---------|------|------|
| **用户可感知** | 用户能直接看到和操作的功能 | "我的位置"按钮、"设置"菜单 |
| **隐私相关性** | 涉及个人信息收集或处理的功能 | 定位功能、数据缓存 |
| **独立性** | 功能可独立描述和禁用 | 单独关闭定位权限不影响手动搜索 |
| **完整性** | 一个功能从触发到完成的完整流程 | 从点击"我的位置"到显示天气的全过程 |

### 1.2 与技术模块的对应关系

| 用户功能模块 | 技术实现模块 | UI入口 |
|------------|------------|--------|
| 天气查询功能 | components/WeatherDisplay.ets<br>pages/Index.ets<br>libNMC/api/ApiManager.ets | 主页、"我的位置"按钮 |
| 城市管理功能 | pages/EditPage.ets<br>components/CityCard.ets<br>manager/RdbManager.ets | "编辑"页面 |
| 设置功能 | pages/SettingPage.ets<br>pages/ApiKeySettingPage.ets<br>manager/PreferenceManager.ts | "设置"菜单 |
| 天气预警功能 | api/ApiManager.ets (qGetWarning)<br>Data/Warning.ets | 主页顶部预警栏 |

---

## 二、功能-权限-隐私映射表

### 2.1 核心功能映射

| 功能模块 | 用户操作路径 | 涉及权限 | 收集的信息 | 第三方共享 | 本地存储 | 代码位置 |
|---------|------------|---------|-----------|-----------|---------|---------|
| **获取当前位置天气** | 主页 → 点击"我的位置" | LOCATION<br>APPROXIMATELY_LOCATION<br>INTERNET | GPS经纬度 | ✅ 和风天气API | ❌ 不存储位置<br>✅ 存储天气数据 | ApiManager.ets:122-160 |
| **搜索城市** | 编辑页 → 搜索框输入 | INTERNET | 城市关键词 | ✅ 和风天气API | ❌ 仅显示结果 | EditPage.ets:175-200 |
| **添加城市** | 编辑页 → 点击搜索结果 | INTERNET | 城市ID、名称 | ✅ 和风天气API | ✅ 本地数据库 | EditPage.ets:62-102<br>RdbManager.ets |
| **刷新天气** | 主页 → 下拉刷新 | INTERNET | 已保存的城市列表 | ✅ 和风天气API | ✅ 更新缓存 | Index.ets:71-157 |
| **删除城市** | 编辑页 → 长按删除 | - | - | - | ✅ 删除本地记录 | EditPage.ets:107-130 |
| **配置API密钥** | 设置 → 密钥设置 | - | API Key字符串 | - | ✅ 加密存储 | ApiKeySettingPage.ets<br>PreferenceManager.ts:68 |
| **语言/单位设置** | 设置 → 相应选项 | - | 偏好设置 | - | ✅ 本地存储 | SettingPage.ets<br>PreferenceManager.ts |
| **查看天气预警** | 主页 → 自动显示 | INTERNET | 城市信息 | ✅ 和风天气API | ✅ 缓存预警 | ApiManager.ets:202-210 |

### 2.2 权限使用详细分析

#### 权限1: 位置信息 (LOCATION / APPROXIMATELY_LOCATION)

**请求时机：**
```typescript
// ApiManager.ets 第122-126行
let grantStatus = await atMan.requestPermissionsFromUser(globalThis.context, 
    ['ohos.permission.APPROXIMATELY_LOCATION'])
if (grantStatus.authResults[0] == 0) {
    let geoLocation = await geoLocationManager.getCurrentLocation();
}
```

**功能必要性分析：**
| 评估项 | 结论 | 理由 |
|-------|------|------|
| 是否必需 | ❌ 否 | 可通过手动搜索城市实现相同功能 |
| 使用频率 | 低频 | 仅在用户主动点击时触发 |
| 数据留存 | 否 | 仅用于当次查询，不持久化存储 |
| 第三方共享 | 是 | 发送给和风天气API |
| 用户可控性 | 强 | 可随时撤回权限 |

#### 权限2: 网络访问 (INTERNET)

**使用场景：**
- 查询城市天气数据
- 搜索城市
- 获取天气预警
- 验证API密钥

**功能必要性分析：**
| 评估项 | 结论 | 理由 |
|-------|------|------|
| 是否必需 | ✅ 是 | 天气数据必须从服务器获取 |
| 使用频率 | 高频 | 每次刷新都需要 |
| 数据加密 | 是 | 使用HTTPS（需验证） |
| 最小必要 | 是 | 仅发送必要的查询参数 |

---

## 三、数据流向分析

### 3.1 位置数据流向图

```
用户点击"我的位置"
    ↓
[权限检查] 是否已授权位置权限？
    ↓ 否
[系统弹窗] 请求位置权限
    ↓ 用户允许
[GPS模块] 获取经纬度
    ↓
[数据处理] 转换为字符串格式
    ↓
[网络请求] HTTPS POST → api.qweather.com
    ↓
[和风天气服务器] 处理请求
    ↓
[返回数据] 城市信息 + 天气数据
    ↓
[本地存储] AppStorage + RDB缓存
    ↓
[UI展示] 显示在主页
    ↓
[内存清理] GPS坐标不持久化，仅保留城市ID
```

### 3.2 第三方数据共享详情

#### 和风天气 API

**数据发送方向：**

| 接口 | 发送的数据 | 返回的数据 | 隐私影响 |
|-----|-----------|-----------|---------|
| qLookupCity | 经纬度或城市名 | 城市列表 | 🟡 中等（可推断位置） |
| qGetWeatherRealTime | 城市ID | 实时天气 | 🟢 低 |
| qGetWeatherDaily | 城市ID | 天气预报 | 🟢 低 |
| qGetWeatherHourly | 城市ID | 小时预报 | 🟢 低 |
| qGetWarning | 城市ID | 预警信息 | 🟢 低 |

**数据接收方能力分析：**
- ✅ 可通过IP地址 + 经纬度精确定位用户
- ✅ 可记录查询历史（访问时间、频率）
- ⚠️ 隐私政策未在应用内明确展示

### 3.3 本地数据存储分析

| 存储类型 | 存储内容 | 加密情况 | 存储位置 | 代码文件 |
|---------|---------|---------|---------|---------|
| **Preferences** | API密钥<br>语言/单位设置<br>缓存配置 | ✅ 系统级加密 | /data/storage/el2/base/preferences/ | PreferenceManager.ts |
| **RDB数据库** | 城市列表<br>天气数据<br>预警信息 | ✅ 系统级加密 | /data/storage/el2/database/rdb/ | RdbManager.ets |
| **AppStorage** | 临时天气数据 | ❌ 内存存储 | 运行时内存 | Index.ets:38-42 |

**敏感度评估：**
- 🔴 **高敏感：** API密钥（泄露可被滥用）
- 🟡 **中敏感：** 城市列表（可推断用户常住地/关注地）
- 🟢 **低敏感：** 天气数据（公开信息）

---

## 四、隐私政策模板结构

### 4.1 标准章节结构（参考华为运动健康）

```
1. 引言
   - 更新日期
   - 生效日期
   - 适用范围

2. 我们如何收集和使用您的个人信息
   ├─ 2.1 功能A（按用户功能划分）
   │   ├─ 功能说明
   │   ├─ 涉及的个人信息
   │   ├─ 使用目的
   │   └─ 您的选择权
   ├─ 2.2 功能B
   └─ 2.3 功能C

3. 我们如何共享、转让、公开披露您的个人信息
   ├─ 3.1 共享（第三方服务清单）
   ├─ 3.2 转让
   └─ 3.3 公开披露

4. 我们如何保护您的个人信息
   ├─ 数据安全措施
   └─ 数据最小化原则

5. 您的权利
   ├─ 5.1 访问和管理您的信息
   ├─ 5.2 删除您的信息
   └─ 5.3 撤回授权

6. Cookie和同类技术

7. 未成年人保护

8. 隐私政策的变更

9. 如何联系我们

10. 附录：权限使用详情
```

### 4.2 关键要素对比

| 要素 | 华为运动健康示例 | 本应用对应内容 |
|-----|----------------|---------------|
| **功能模块** | "我的">"设置">"数据管理" | "编辑页面"、"设置" |
| **数据删除路径** | "清除本地应用数据" | 卸载应用 / 系统设置清除数据 |
| **删除范围** | 列举：个人信息、运动数据、健康数据 | 城市列表、天气缓存、API密钥、设置 |
| **第三方服务** | 明确列出服务商和隐私政策链接 | 和风天气API + 隐私政策链接 |
| **用户控制** | 提供多种删除方式 | 单个删除 / 批量清除 |

---

## 五、对比分析：真实鸿蒙应用

### 5.1 应用对比清单

| 应用名称 | 应用类型 | 权限数量 | 功能模块数 | 隐私政策页数 | 特色做法 |
|---------|---------|---------|-----------|------------|---------|
| **ohos-weather-beta**（本应用） | 天气类 | 3个 | 4个 | 0（无） | 开源、最小化权限 |
| **华为天气**（需人工分析） | 天气类 | [待填] | [待填] | [待填] | [待填] |
| **高德地图** | 地图类 | [待填] | [待填] | [待填] | [待填] |

### 5.2 建议分析步骤

#### 步骤1: 下载和安装
```bash
# 从华为应用市场下载
# 或使用开发者账号获取HAP包
```

#### 步骤2: 权限分析
```bash
# 查看module.json5
# 记录所有requestPermissions
# 分类：必需/非必需
```

#### 步骤3: 功能梳理
- 截图所有功能入口
- 绘制功能导航图
- 识别涉及隐私的功能

#### 步骤4: 隐私政策对比
- 导出或截图隐私政策全文
- 分析章节结构
- 提取功能-隐私映射关系

---

## 六、研究发现与建议

### 6.1 当前应用的隐私合规问题

| 问题类型 | 具体问题 | 风险等级 | 改进建议 |
|---------|---------|---------|---------|
| **缺失隐私政策** | 应用内无隐私政策页面 | 🔴 高 | 添加AboutPage.ets中的隐私政策入口 |
| **权限说明不足** | module.json5仅有reason字段 | 🟡 中 | 在首次请求权限时弹窗详细说明 |
| **第三方告知** | 未明确告知数据发送给和风天气 | 🟡 中 | 在隐私政策中列出第三方清单 |
| **数据删除** | 无应用内数据删除功能 | 🟢 低 | 仅依赖系统功能即可 |
| **最小必要** | ✅ 位置权限仅在需要时请求 | ✅ 合规 | - |

### 6.2 模块划分的最佳实践

**核心原则：用户中心 + 场景驱动**

1. **按用户操作路径划分**
   - ✅ 好示例："点击'我的位置' → 获取定位 → 显示天气"
   - ❌ 差示例："定位模块"、"网络模块"（技术视角）

2. **一个功能一个说明**
   - ✅ "天气查询功能"涵盖定位、搜索、显示
   - ❌ 拆分成"定位功能"、"显示功能"（过细）

3. **与UI入口对应**
   - ✅ "设置功能" = 用户看到的"设置"菜单
   - ❌ "PreferenceManager模块"（代码名称）

### 6.3 隐私报告撰写建议

**面向不同受众：**

| 受众类型 | 侧重点 | 文档示例 |
|---------|-------|---------|
| **普通用户** | 简洁易懂、操作指引 | 隐私政策-用户版.md |
| **监管部门** | 合规性、技术细节 | 本报告（研究版） |
| **学术研究** | 方法论、数据流向 | 功能-隐私映射表 |

---

## 七、下一步工作计划

### 7.1 补充分析（建议1-2周内完成）

- [ ] **任务1:** 下载华为天气应用，进行对比分析
- [ ] **任务2:** 使用抓包工具验证HTTPS加密
- [ ] **任务3:** 反编译HAP包，验证代码实现
- [ ] **任务4:** 查阅和风天气隐私政策，分析第三方风险
- [ ] **任务5:** 制作用户操作流程图（配截图）

### 7.2 报告完善

- [ ] 补充真实应用对比数据（华为天气 + 1个其他应用）
- [ ] 添加代码片段截图到附录
- [ ] 制作数据流向可视化图表
- [ ] 撰写研究结论和方法论总结

### 7.3 成果输出

- [ ] **学术论文草稿**（如适用）
- [ ] **向导师汇报的PPT**（15页左右）
- [ ] **隐私报告模板**（可复用于其他应用）
- [ ] **自动化分析工具**（Python脚本）

---

## 八、参考资料

### 8.1 法律法规
- 《中华人民共和国个人信息保护法》
- 《App违法违规收集使用个人信息行为认定方法》
- 工信部《移动互联网应用程序个人信息保护管理暂行规定》

### 8.2 技术标准
- GB/T 35273-2020《信息安全技术 个人信息安全规范》
- TC260-PG-20223A《移动互联网应用程序(App)个人信息保护常见问题及处置指南》

### 8.3 HarmonyOS文档
- [权限列表](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/permission-list-0000001544464013-V3)
- [数据管理](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/data-management-0000001544703945-V3)

---

## 附录A：代码审计清单

### 位置权限相关代码

**文件：** `libNMC/src/main/ets/api/ApiManager.ets`

```typescript
// 第122-126行：请求位置权限
let atMan = abilityAccessCtrl.createAtManager();
let grantStatus = await atMan.requestPermissionsFromUser(globalThis.context, 
    ['ohos.permission.APPROXIMATELY_LOCATION'])
if (grantStatus.authResults[0] == 0) {
    let geoLocation = await geoLocationManager.getCurrentLocation();
    currentLocation.lat = geoLocation.latitude.toString();
    currentLocation.lon = geoLocation.longitude.toString();
}
```

**隐私影响分析：**
- ✅ 使用粗略位置（APPROXIMATELY_LOCATION），符合最小必要原则
- ✅ 仅在authResults==0时获取，有权限检查
- ⚠️ 未提前告知用户数据用途（建议添加弹窗说明）

### 网络请求相关代码

**文件：** `libNMC/src/main/ets/api/TaskManager.ets`

```typescript
// 网络请求封装
httpRequest.request(url, {
    method: http.RequestMethod.GET,
    extraData: params,
    // ... 其他配置
})
```

**待验证项：**
- [ ] 是否使用HTTPS（需抓包验证）
- [ ] 是否有请求签名（防篡改）
- [ ] 是否有请求频率限制

---

## 附录B：用户操作流程图

```
[主页]
  │
  ├─ 点击"我的位置" → [权限弹窗] → [定位] → [显示当前城市天气]
  │
  ├─ 下拉刷新 → [网络请求] → [更新所有城市天气]
  │
  ├─ 左右滑动 → [切换已添加的城市]
  │
  ├─ 点击"设置"图标 → [设置页]
  │                      │
  │                      ├─ 语言设置
  │                      ├─ 单位设置
  │                      ├─ 密钥设置 → [输入API Key] → [保存到本地]
  │                      └─ 高级设置
  │
  └─ 点击"编辑"图标 → [编辑页]
                         │
                         ├─ 搜索城市 → [输入关键词] → [显示结果]
                         │
                         ├─ 点击搜索结果 → [添加城市] → [保存到数据库]
                         │
                         └─ 长按城市卡片 → [删除城市] → [从数据库删除]
```

---

**报告完成度：** 80%  
**待补充内容：** 真实应用对比数据、抓包验证结果、截图素材

**建议后续工作：**
1. 使用本报告作为基础，完成真实应用的对比分析
2. 将"隐私政策-用户版.md"整合到应用中（添加AboutPage）
3. 基于本研究撰写论文或向导师汇报
