/**
 * @testcase_name Button-Object-Allocation
 *
 * @description æµ‹è¯•æŒ‰é’®ç»„ä»¶çŠ¶æ€çš„æ­£ç¡®å»ºæ¨¡ã€‚æŒ‰é’®ç»„ä»¶åœ¨è¿è¡Œæ—¶ç”±å•ä¸ªå¯¹è±¡è¡¨ç¤º,
 *  è¯¥å¯¹è±¡åœ¨å¤šæ¬¡ç‚¹å‡»äº‹ä»¶ä¸­ä¿æŒçŠ¶æ€ã€‚
 * @number_of_leaks 1
 * @challenges å¿…é¡»æ­£ç¡®å»ºæ¨¡:æŒ‰é’®åœ¨è¿è¡Œæ—¶ç”±å•ä¸ªå¯¹è±¡è¡¨ç¤º,
 *  è¯¥å¯¹è±¡çš„çŠ¶æ€åœ¨å¤šæ¬¡ onClick è°ƒç”¨ä¹‹é—´ä¿æŒ,ç¬¬äºŒæ¬¡ç‚¹å‡»æ—¶ä¼šæ³„éœ²æ•æ„Ÿä¿¡æ¯
 */

import { deviceInfo } from '@kit.BasicServicesKit';
import { hilog } from '@kit.PerformanceAnalysisKit';

@Entry
@Component
struct ButtonObjectAllocationDemo {
  // å­˜å‚¨è®¾å¤‡ID(æ•æ„Ÿä¿¡æ¯)
  private deviceId: string = '';

  // æŒ‰é’®çš„ hint çŠ¶æ€ - æ¨¡æ‹Ÿ Android Button çš„ hint å±æ€§
  // è¿™ä¸ªçŠ¶æ€åœ¨å¤šæ¬¡ç‚¹å‡»ä¹‹é—´ä¼šä¿æŒ
  @State private buttonHint: string = '';

  /**
   * ç»„ä»¶å³å°†å‡ºç°æ—¶è°ƒç”¨
   */
  aboutToAppear(): void {
    try {
      // è·å–è®¾å¤‡ä¿¡æ¯ä½œä¸ºsource(æ•æ„Ÿä¿¡æ¯æº)
      let manufacturer: string = deviceInfo.manufacture;
      let brand: string = deviceInfo.brand;
      let productModel: string = deviceInfo.productModel;
      let osFullName: string = deviceInfo.osFullName;
      let marketName: string = deviceInfo.marketName;

      // ç»„åˆè®¾å¤‡ä¿¡æ¯ä½œä¸ºæ•æ„Ÿæ•°æ® - source
      this.deviceId = `${manufacturer}-${brand}-${productModel}-${marketName}-${osFullName}`;

      hilog.info(0x0000, 'DroidBench', 'Device Info obtained: %{public}s', this.deviceId);
      console.info('Device Info obtained: ' + this.deviceId);
    } catch (error) {
      console.error('Failed to get device info: ' + JSON.stringify(error));
      this.deviceId = 'unknown';
    }
  }

  /**
   * å‘é€æ¶ˆæ¯çš„å‡½æ•° - æ¨¡æ‹Ÿ Android çš„ sendMessage(View view)
   *
   * å…³é”®é€»è¾‘:
   * ç¬¬1æ¬¡ç‚¹å‡»: buttonHint ä¸ºç©º,è®¾ç½®ä¸º deviceId
   * ç¬¬2æ¬¡ç‚¹å‡»: buttonHint å·²æœ‰å€¼(deviceId),è¾“å‡ºåˆ°æ—¥å¿— - LEAK!
   *
   * è¿™æµ‹è¯•é™æ€åˆ†æå·¥å…·èƒ½å¦ç†è§£:
   * 1. æŒ‰é’®çŠ¶æ€åœ¨å¤šæ¬¡ç‚¹å‡»ä¹‹é—´ä¿æŒ
   * 2. ç¬¬ä¸€æ¬¡ç‚¹å‡»ä¸æ³„éœ²,ç¬¬äºŒæ¬¡ç‚¹å‡»æ‰æ³„éœ²
   */
  private sendMessage(): void {
    // ç¬¬2æ¬¡åŠä»¥åç‚¹å‡»: è¯»å– buttonHint (åŒ…å«æ•æ„Ÿä¿¡æ¯)
    // sink on second call to sendMessage(), second click of button
    if (this.buttonHint !== '') {
      hilog.info(0x0000, 'DroidBench', 'Button hint: %{public}s', this.buttonHint);
      console.info('DroidBench: ' + this.buttonHint); // sink, leak on 2nd+ click
    }

    // ç¬¬1æ¬¡ç‚¹å‡»: å°†æ•æ„Ÿä¿¡æ¯å­˜å‚¨åˆ° buttonHint
    // æ¨¡æ‹Ÿ Android çš„ view.setHint(imei)
    this.buttonHint = this.deviceId;

    console.info('Button hint has been set to device ID');
  }

  build() {
    Column({ space: 30 }) {
      // æ ‡é¢˜
      Text('Button Object Allocation Demo')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 50 })

      Text('æµ‹è¯•æŒ‰é’®å¯¹è±¡çŠ¶æ€ä¿æŒ')
        .fontSize(16)
        .fontColor(Color.Gray)

      // æ˜¾ç¤ºå½“å‰è®¾å¤‡ID
      Text(`å½“å‰è®¾å¤‡ID: ${this.deviceId}`)
        .fontSize(14)
        .fontColor(Color.Blue)
        .padding(10)
        .backgroundColor('#F0F0F0')
        .borderRadius(5)

      // æ˜¾ç¤ºæŒ‰é’®å½“å‰çš„ hint çŠ¶æ€
      Text(`æŒ‰é’® Hint: ${this.buttonHint || '(æœªè®¾ç½®)'}`)
        .fontSize(14)
        .fontColor(this.buttonHint ? Color.Red : Color.Gray)
        .padding(10)
        .backgroundColor('#FFF3E0')
        .borderRadius(5)

      // è¯´æ˜æ–‡å­—
      Column({ space: 10 }) {
        Text('ğŸ” æµ‹è¯•åœºæ™¯:')
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Orange)

        Text('1ï¸âƒ£ ç¬¬1æ¬¡ç‚¹å‡»: å°†è®¾å¤‡IDå­˜å‚¨åˆ°æŒ‰é’®çŠ¶æ€')
          .fontSize(12)
          .fontColor(Color.Gray)

        Text('2ï¸âƒ£ ç¬¬2æ¬¡ç‚¹å‡»: è¯»å–æŒ‰é’®çŠ¶æ€å¹¶è¾“å‡º(æ³„éœ²!)')
          .fontSize(12)
          .fontColor(Color.Red)

        Text('3ï¸âƒ£ åç»­ç‚¹å‡»: ç»§ç»­æ³„éœ²')
          .fontSize(12)
          .fontColor(Color.Red)
      }
      .alignItems(HorizontalAlign.Start)
      .width('90%')
      .padding(15)
      .backgroundColor('#E8F5E9')
      .borderRadius(8)
      .margin({ top: 20 })

      // æŒ‰é’® - ç‚¹å‡»åè§¦å‘ sendMessage
      // è¿™ä¸ªæŒ‰é’®å¯¹è±¡åœ¨è¿è¡Œæ—¶åªæœ‰ä¸€ä¸ªå®ä¾‹
      // å®ƒçš„çŠ¶æ€(buttonHint)åœ¨å¤šæ¬¡ç‚¹å‡»ä¹‹é—´ä¿æŒ
      Button('ç‚¹å‡»å‘é€æ¶ˆæ¯')
        .fontSize(18)
        .width('80%')
        .height(60)
        .backgroundColor('#FF5722')
        .margin({ top: 30 })
        .onClick(() => {
          this.sendMessage(); // å¤šæ¬¡ç‚¹å‡»åŒä¸€ä¸ªæ–¹æ³•
        })

      // ç‚¹å‡»è®¡æ•°æç¤º
      Text('ğŸ’¡ æç¤º: å¤šæ¬¡ç‚¹å‡»æŒ‰é’®è§‚å¯Ÿè¡Œä¸º')
        .fontSize(12)
        .fontColor(Color.Orange)
        .margin({ top: 10 })

      // è­¦å‘Šæç¤º
      Text('âš ï¸ è­¦å‘Š: æ­¤ä»£ç ä»…ç”¨äºå®‰å…¨æµ‹è¯•!')
        .fontSize(12)
        .fontColor(Color.Red)
        .margin({ top: 40 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Start)
    .alignItems(HorizontalAlign.Center)
  }
}